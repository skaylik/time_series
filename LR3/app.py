"""
–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Streamlit –¥–ª—è –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–∞–∫—Ç–∏–∫—É–º–∞ ‚Ññ 3.
–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å–µ —ç—Ç–∞–ø—ã –∞–Ω–∞–ª–∏–∑–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤:
- –≠—Ç–∞–ø 1: –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
- –≠—Ç–∞–ø 2: Feature engineering
- –≠—Ç–∞–ø 3: –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
- –≠—Ç–∞–ø 4: –ö—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è
- –≠—Ç–∞–ø 5: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
- –≠—Ç–∞–ø 6: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–æ–¥–µ–ª–µ–π
- –≠—Ç–∞–ø 7: –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
- –≠—Ç–∞–ø 9: –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
"""

import io
import warnings
from typing import Callable, Dict, List, Optional, Tuple

# –ü–æ–¥–∞–≤–ª—è–µ–º FutureWarning –æ—Ç sklearn –î–û –∏–º–ø–æ—Ä—Ç–∞ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –∑–∞—Å–æ—Ä—è–µ—Ç –≤—ã–≤–æ–¥)
warnings.filterwarnings('ignore', category=FutureWarning, module='sklearn')
warnings.filterwarnings('ignore', message='.*force_all_finite.*')  # –ü–æ–¥–∞–≤–ª—è–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

import numpy as np
import pandas as pd
import streamlit as st
from sklearn.ensemble import RandomForestRegressor
from sklearn.linear_model import LinearRegression

from preprocessing_transformations import stage1
from data_partitioning_feature_engineering import stage2
from forecasting_strategies_horizons import stage3
from time_series_cross_validation import stage4
from model_building_analysis import stage5
from model_diagnostics import stage6
from model_evaluation_comparison import stage7
from conclusions_recommendations import stage9


st.set_page_config(page_title="üß™ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–π –ø—Ä–∞–∫—Ç–∏–∫—É–º ‚Ññ 3", page_icon="üìä", layout="wide")


ALPHA = 0.05
DEFAULT_LAGS = [1, 2, 7, 30]
DEFAULT_ROLLING_WINDOWS = [7, 30]
DEFAULT_SPLIT = (70, 15, 15)
DEFAULT_HORIZONS = [1, 7, 14]  # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: –¥–ª—è –∫—É—Ä—Å–∞ –¥–æ–ª–ª–∞—Ä–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 14 –¥–Ω–µ–π (2 –Ω–µ–¥–µ–ª–∏)

MODEL_FACTORIES: Dict[str, Callable[[], object]] = {
    "LinearRegression": lambda: LinearRegression(),
    "RandomForestRegressor": lambda: RandomForestRegressor(
        n_estimators=100,  # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: —É–º–µ–Ω—å—à–µ–Ω–æ —Å 200 –¥–æ 100 –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
        max_depth=10,  # –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –≥–ª—É–±–∏–Ω–∞ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è (–±—ã–ª–æ None)
        random_state=42, 
        n_jobs=-1
    ),
}

try:
    import pmdarima as pm

    PMDARIMA_AVAILABLE = True
except ImportError:  # pragma: no cover - optional dependency
    PMDARIMA_AVAILABLE = False

try:
    from arch import arch_model

    ARCH_AVAILABLE = True
except ImportError:  # pragma: no cover - optional dependency
    ARCH_AVAILABLE = False

try:
    from tbats import TBATS

    TBATS_AVAILABLE = True
except ImportError:  # pragma: no cover - optional dependency
    TBATS_AVAILABLE = False

PROPHET_AVAILABLE = False
try:
    from prophet import Prophet  # type: ignore

    PROPHET_AVAILABLE = True
except ImportError:  # pragma: no cover - optional dependency
    try:
        from fbprophet import Prophet  # type: ignore

        PROPHET_AVAILABLE = True
    except ImportError:
        PROPHET_AVAILABLE = False


def load_dataset(uploaded_file: io.BytesIO) -> pd.DataFrame:
    if uploaded_file is None:
        raise ValueError("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.")

    file_name = uploaded_file.name.lower()
    if file_name.endswith(".csv"):
        return pd.read_csv(uploaded_file)
    if file_name.endswith(".parquet"):
        return pd.read_parquet(uploaded_file)

    raise ValueError("–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã CSV –∏ Parquet.")


def find_datetime_columns(df: pd.DataFrame) -> List[str]:
    candidates: List[str] = []
    for column in df.columns:
        series = df[column]
        if pd.api.types.is_datetime64_any_dtype(series):
            candidates.append(column)
            continue

        converted = pd.to_datetime(series, errors="coerce")
        if converted.notna().sum() >= int(0.8 * len(series)):
            candidates.append(column)
    return candidates


def main() -> None:
    st.title("üß™ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–π –ø—Ä–∞–∫—Ç–∏–∫—É–º ‚Ññ 3")
    st.markdown("### –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –º–æ–¥–µ–ª–µ–π –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤")
    st.info("üí° **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –≥–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 7 –¥–Ω–µ–π. "
            "–†–∞–∑–º–µ—Ä –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞—Ç–∞—Å–µ—Ç–æ–≤. "
            "–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ (TBATS, SARIMA) –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —á–µ–∫–±–æ–∫—Å.")

    with st.expander("üìö –ö—Ä–∞—Ç–∫–∞—è —Ç–µ–æ—Ä–∏—è", expanded=False):
        st.markdown(
            """
            **–≠—Ç–∞–ø—ã –ø—Ä–∞–∫—Ç–∏–∫—É–º–∞**

            - **–≠—Ç–∞–ø 1. –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è** ‚Äî –∞–Ω–∞–ª–∏–∑ –ª–æ–≥/Box‚ÄìCox —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π –∏ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–π —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ—Å—Ç–∏ (ADF, KPSS).
            - **–≠—Ç–∞–ø 2. Feature engineering** ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–∞–≥–æ–≤, —Å–∫–æ–ª—å–∑—è—â–∏—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫, –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –∏ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –≤—ã–±–æ—Ä–æ–∫.
            - **–≠—Ç–∞–ø 3. –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è** ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä—è–º–æ–π, —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–π –∏ –≥–∏–±—Ä–∏–¥–Ω–æ–π —Å—Ö–µ–º –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞—Ö `h`.
            - **–≠—Ç–∞–ø 4. –ö—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî —Ä–∞—Å—à–∏—Ä—è—é—â–µ–µ—Å—è –æ–∫–Ω–æ, —Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ, TimeSeriesSplit.
            - **–≠—Ç–∞–ø 5. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π** ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –º–æ–¥–µ–ª–µ–π –Ω–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ.
            - **–≠—Ç–∞–ø 6. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–æ–¥–µ–ª–µ–π** ‚Äî —Ç–µ—Å—Ç—ã –õ—å—é–Ω–≥–∞-–ë–æ–∫—Å–∞, –®–∞–ø–∏—Ä–æ-–£–∏–ª–∫–∞, Breusch-Pagan, ACF/PACF –æ—Å—Ç–∞—Ç–∫–æ–≤.
            - **–≠—Ç–∞–ø 7. –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ** ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞, —Ç–µ—Å—Ç Diebold‚ÄìMariano, —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π.
            - **–≠—Ç–∞–ø 9. –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** ‚Äî –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –º–æ–¥–µ–ª–µ–π, –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É.
            """
        )

    # –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å - –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
    st.sidebar.markdown("### üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö")
    uploaded_file = st.sidebar.file_uploader(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª",
        type=["csv", "parquet"],
        help="–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–∞–π–ª—ã CSV –∏ Parquet",
        label_visibility="collapsed"
    )

    # –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å - –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    if uploaded_file is None:
        st.info("üëÜ –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É.")
        return

    # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
    try:
        df = load_dataset(uploaded_file)
        st.session_state["df"] = df
        st.session_state["file_loaded"] = True
    except Exception as exc:  # pragma: no cover - streamlit feedback
        st.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª: {exc}")
        st.stop()

    # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    if st.session_state.get("file_loaded", False):
        df = st.session_state["df"]
        
        st.markdown("---")
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
        st.success(f"‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: {uploaded_file.name if uploaded_file else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∞–π–ª'}")
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö
        st.subheader("üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∞–Ω–Ω—ã—Ö")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü —Å –¥–∞—Ç–æ–π –¥–ª—è –º–µ—Ç—Ä–∏–∫
        date_columns_for_metrics = [
            col for col in df.columns 
            if df[col].dtype == "object" or pd.api.types.is_datetime64_any_dtype(df[col])
        ]
        date_col_for_metrics = date_columns_for_metrics[0] if date_columns_for_metrics else None
        
        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("üìä –°—Ç—Ä–æ–∫", f"{df.shape[0]:,}")
        with col2:
            st.metric("üìë –°—Ç–æ–ª–±—Ü–æ–≤", f"{df.shape[1]:,}")
        with col3:
            if date_col_for_metrics:
                try:
                    date_start = str(df[date_col_for_metrics].min())[:10]
                except Exception:
                    date_start = "N/A"
            else:
                date_start = "N/A"
            st.metric("üìÖ –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞", date_start)
        with col4:
            if date_col_for_metrics:
                try:
                    date_end = str(df[date_col_for_metrics].max())[:10]
                except Exception:
                    date_end = "N/A"
            else:
                date_end = "N/A"
            st.metric("üìÖ –î–∞—Ç–∞ –∫–æ–Ω—Ü–∞", date_end)
        
        st.markdown("---")
        
        # –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
        st.subheader("üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö")
        
        with st.expander("üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", expanded=False):
            st.dataframe(df.head(10), use_container_width=True)
            
            if date_col_for_metrics:
                try:
                    st.write(f"**üìÖ –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç:**")
                    st.write(f"{df[date_col_for_metrics].min()} - {df[date_col_for_metrics].max()}")
                except Exception:
                    st.info("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç")
            
            st.markdown("---")
            
            # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º —á–∏—Å–ª–æ–≤—ã–º —Å—Ç–æ–ª–±—Ü–∞–º
            st.markdown("#### üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º —á–∏—Å–ª–æ–≤—ã–º —Å—Ç–æ–ª–±—Ü–∞–º")
            numeric_cols = df.select_dtypes(include=[np.number]).columns.tolist()
            if numeric_cols:
                st.dataframe(df[numeric_cols].describe(), use_container_width=True)
            else:
                st.info("–ù–µ—Ç —á–∏—Å–ª–æ–≤—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
        
        st.markdown("---")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
        numeric_columns = df.select_dtypes(include=[np.number]).columns.tolist()
        if not numeric_columns:
            st.error("‚ùå –í –Ω–∞–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç —á–∏—Å–ª–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")
            st.stop()

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if "lab3_state" not in st.session_state:
            st.session_state["lab3_state"] = {
                "stage1_completed": False,
                "stage2_completed": False,
                "stage3_completed": False,
                "stage4_completed": False,
                "stage5_completed": False,
                "stage6_completed": False,
                "stage7_completed": False,
                "stage9_completed": False,
            }
        lab_state = st.session_state["lab3_state"]

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã —Ñ–∞–π–ª–∞
        current_file_name = getattr(uploaded_file, "name", None)
        if "analysis_data" not in st.session_state:
            st.session_state["analysis_data"] = None
            st.session_state["active_file_name"] = current_file_name
            lab_state.update(
                {
                    "stage1_completed": False,
                    "stage2_completed": False,
                    "stage3_completed": False,
                    "stage4_completed": False,
                    "stage5_completed": False,
                    "stage6_completed": False,
                    "stage7_completed": False,
                    "stage9_completed": False,
                }
            )
        elif st.session_state.get("active_file_name") != current_file_name:
            st.session_state["analysis_data"] = None
            st.session_state["active_file_name"] = current_file_name
            lab_state.update(
                {
                    "stage1_completed": False,
                    "stage2_completed": False,
                    "stage3_completed": False,
                    "stage4_completed": False,
                    "stage5_completed": False,
                    "stage6_completed": False,
                    "stage7_completed": False,
                    "stage9_completed": False,
                }
            )

        analysis_data = st.session_state.get("analysis_data")
        
        # –≠—Ç–∞–ø 1: –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
        st.markdown("---")
        st.subheader("üîÑ –≠—Ç–∞–ø 1. –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è")
        st.caption("–ê–Ω–∞–ª–∏–∑ –ª–æ–≥/Box‚ÄìCox —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π –∏ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–π —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ—Å—Ç–∏ (ADF, KPSS).")
        
        with st.expander("üìö –¢–µ–æ—Ä–∏—è –ø–æ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–µ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è–º", expanded=False):
            st.markdown(
            """
            **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å—Ç–∞—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤:**
            
            - **–õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ**: –°—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç –¥–∏—Å–ø–µ—Ä—Å–∏—é, –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –¥–∞–Ω–Ω—ã—Ö —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º —Ä–æ—Å—Ç–æ–º.
              –§–æ—Ä–º—É–ª–∞: `Y(t) = log(X(t))` –∏–ª–∏ `Y(t) = log(X(t) + c)` –¥–ª—è –Ω–µ–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π.
            
            - **–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Box-Cox**: –ë–æ–ª–µ–µ –≥–∏–±–∫–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ, –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑—É–µ–º–æ–µ Œª (–ª—è–º–±–¥–∞).
              –§–æ—Ä–º—É–ª–∞: `Y(t) = (X(t)^Œª - 1) / Œª` –¥–ª—è Œª ‚â† 0, –∏ `Y(t) = log(X(t))` –¥–ª—è Œª = 0.
              –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–±–æ—Ä Œª –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –¥–∏—Å–ø–µ—Ä—Å–∏—é –∏–ª–∏ –º–∞–∫—Å–∏–º–∏–∑–∏—Ä—É–µ—Ç –ª–æ–≥–∞—Ä–∏—Ñ–º –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–∏—è.
            
            - **–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞**: –£—Å—Ç—Ä–∞–Ω—è–µ—Ç —Ç—Ä–µ–Ω–¥ –≤ –¥–∞–Ω–Ω—ã—Ö.
              –§–æ—Ä–º—É–ª–∞: `Y(t) = X(t) - X(t-1)`. –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ —Ä—è–¥ –Ω–µ—Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–µ–Ω –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É.
            
            - **–°–µ–∑–æ–Ω–Ω–æ–µ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ**: –£—Å—Ç—Ä–∞–Ω—è–µ—Ç —Å–µ–∑–æ–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã.
              –§–æ—Ä–º—É–ª–∞: `Y(t) = X(t) - X(t-s)`, –≥–¥–µ s ‚Äî –ø–µ—Ä–∏–æ–¥ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏.
            
            **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ—Å—Ç–∏:**
            
            - **–¢–µ—Å—Ç ADF (Augmented Dickey-Fuller)**: 
              - H0: —Ä—è–¥ –Ω–µ—Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–µ–Ω (–µ—Å—Ç—å –µ–¥–∏–Ω–∏—á–Ω—ã–π –∫–æ—Ä–µ–Ω—å)
              - –ï—Å–ª–∏ p-value < 0.05 ‚Üí –æ—Ç–≤–µ—Ä–≥–∞–µ–º H0 ‚Üí —Ä—è–¥ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–µ–Ω
              - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è: -3.43 (1%), -2.86 (5%), -2.57 (10%)
            
            - **–¢–µ—Å—Ç KPSS (Kwiatkowski-Phillips-Schmidt-Shin)**:
              - H0: —Ä—è–¥ —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–µ–Ω (–æ–∫–æ–ª–æ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞)
              - –ï—Å–ª–∏ p-value < 0.05 ‚Üí –æ—Ç–≤–µ—Ä–≥–∞–µ–º H0 ‚Üí —Ä—è–¥ –Ω–µ—Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–µ–Ω
              - –î–æ–ø–æ–ª–Ω—è–µ—Ç ADF —Ç–µ—Å—Ç –¥–ª—è –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
            
            **–¶–µ–ª—å –±–ª–æ–∫–∞:** –ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Ü–µ–ø–æ—á–∫—É –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â—É—é —Å—Ç–∞—Ü–∏–æ–Ω–∞—Ä–Ω–æ—Å—Ç—å —Ä—è–¥–∞
            –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏ (ARIMA, SARIMA –∏ –¥—Ä.).
            """
            )
        
        analysis_data = stage1(df, analysis_data, lab_state, ALPHA)
        st.session_state["analysis_data"] = analysis_data

        # –≠—Ç–∞–ø 2: Feature engineering
        st.markdown("---")
        st.subheader("üßÆ –≠—Ç–∞–ø 2. Feature engineering")
        st.caption("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–∞–≥–æ–≤, —Å–∫–æ–ª—å–∑—è—â–∏—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫, –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –∏ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –≤—ã–±–æ—Ä–æ–∫.")
        
        with st.expander("üìö –¢–µ–æ—Ä–∏—è –ø–æ feature engineering", expanded=False):
            st.markdown(
            """
            **–ó–∞—á–µ–º –Ω—É–∂–µ–Ω feature engineering –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤?**
            
            –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–æ–¥–µ–ª—è–º —É—á–∏—Ç—ã–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤ –¥–∞–Ω–Ω—ã—Ö:
            
            - **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏** (–¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏, –º–µ—Å—è—Ü, –∫–≤–∞—Ä—Ç–∞–ª, –≥–æ–¥):
              - –ü–æ–∑–≤–æ–ª—è—é—Ç –º–æ–¥–µ–ª–∏ —É—á–µ—Å—Ç—å –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏
              - –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –ø—è—Ç–Ω–∏—Ü—ã –ø–æ –ø–æ–≤–µ–¥–µ–Ω–∏—é –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä—è–¥–∞
            
            - **–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏** (sin/cos –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏):
              - –°–æ—Ö—Ä–∞–Ω—è—é—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞—Ö
              - –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –±–ª–∏–∑–∫–∏ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é (—Ü–∏–∫–ª–∏—á–Ω–æ—Å—Ç—å –Ω–µ–¥–µ–ª–∏)
              - –§–æ—Ä–º—É–ª–∞: `sin(2œÄ * t / –ø–µ—Ä–∏–æ–¥)`, `cos(2œÄ * t / –ø–µ—Ä–∏–æ–¥)`
            
            - **–õ–∞–≥–∏** (`lag_1`, `lag_7`, `lag_30`):
              - –î–∞—é—Ç –º–æ–¥–µ–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ—à–ª—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º —Ä—è–¥–∞
              - `lag_k` = –∑–Ω–∞—á–µ–Ω–∏–µ —Ä—è–¥–∞ –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ `t-k`
              - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã –¥–ª—è –º–æ–¥–µ–ª–µ–π –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è (LinearRegression, RandomForest)
            
            - **–°–∫–æ–ª—å–∑—è—â–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** (—Å—Ä–µ–¥–Ω–µ–µ, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ, –º–∏–Ω–∏–º—É–º, –º–∞–∫—Å–∏–º—É–º):
              - –û—Ç—Ä–∞–∂–∞—é—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –¥–∏–Ω–∞–º–∏–∫—É —Ä—è–¥–∞
              - –°–∫–æ–ª—å–∑—è—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ: `MA(t, w) = mean(X[t-w:t])`
              - –ü–æ–º–æ–≥–∞—é—Ç —É–ª–æ–≤–∏—Ç—å —Ç—Ä–µ–Ω–¥—ã –∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –≤ –æ–∫–Ω–µ —Ä–∞–∑–º–µ—Ä–∞ `w`
            
            - **–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å** (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –≤–∞—Ä–∏–∞—Ü–∏–∏):
              - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å/–∏–∑–º–µ–Ω—á–∏–≤–æ—Å—Ç—å —Ä—è–¥–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –æ–∫–Ω–µ
              - `CV(t, w) = std(X[t-w:t]) / mean(X[t-w:t])`
            
            - **–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏** (–≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏, –ø—Ä–∞–∑–¥–Ω–∏–∫–∏):
              - –ü–æ–º–æ–≥–∞—é—Ç —É—á–µ—Å—Ç—å –≤–Ω–µ—à–Ω–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ä—è–¥–∞
              - –ú–æ–≥—É—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ –¥–ª—è –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫
            """
            )
        
        analysis_data = stage2(analysis_data, lab_state, DEFAULT_LAGS, DEFAULT_ROLLING_WINDOWS, DEFAULT_SPLIT)
        st.session_state["analysis_data"] = analysis_data

        # –≠—Ç–∞–ø 3: –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
        st.markdown("---")
        st.subheader("üîÆ –≠—Ç–∞–ø 3. –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã")
        st.caption("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä—è–º–æ–π, —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–π –∏ –≥–∏–±—Ä–∏–¥–Ω–æ–π —Å—Ö–µ–º –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö –∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞—Ö h=1, 7, 30.")
        
        with st.expander("üìö –¢–µ–æ—Ä–∏—è –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è", expanded=False):
            st.markdown(
            """
            **–ü–æ–¥—Ö–æ–¥—ã –∫ –º–Ω–æ–≥–æ–ø–µ—Ä–∏–æ–¥–Ω–æ–º—É –ø—Ä–æ–≥–Ω–æ–∑—É:**
            
            - **–†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (Recursive)**:
              - –û–±—É—á–∞–µ—Ç—Å—è –æ–¥–Ω–∞ –º–æ–¥–µ–ª—å –¥–ª—è —à–∞–≥–∞ `t+1`
              - –ü—Ä–æ–≥–Ω–æ–∑—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥–∞—é—Ç—Å—è –Ω–∞ –≤—Ö–æ–¥ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞ —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤
              - –§–æ—Ä–º—É–ª–∞: `≈∑_{t+1} = f(X_t)`, `≈∑_{t+2} = f(X_t, ≈∑_{t+1})`, ...
              - **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**: –¢—Ä–µ–±—É–µ—Ç –æ–±—É—á–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–π –º–æ–¥–µ–ª–∏, –±—ã—Å—Ç—Ä–æ —Ä–∞–±–æ—Ç–∞–µ—Ç
              - **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**: –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞
            
            - **–ü—Ä—è–º–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (Direct)**:
              - –û–±—É—á–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ `t+h`
              - –ö–∞–∂–¥–∞—è –º–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ `h`
              - –§–æ—Ä–º—É–ª–∞: `≈∑_{t+h} = f_h(X_t)` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ `h ‚àà [1, H]`
              - **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**: –£—Å—Ç–æ–π—á–∏–≤–µ–µ –∫ –æ—à–∏–±–∫–∞–º, –Ω–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫
              - **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**: –¢—Ä–µ–±—É–µ—Ç –æ–±—É—á–µ–Ω–∏—è H –º–æ–¥–µ–ª–µ–π (–±–æ–ª—å—à–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π)
            
            - **–ì–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (Hybrid)**:
              - –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç –ø–æ–¥—Ö–æ–¥—ã: —Ä–µ–∫—É—Ä—Å–∏—è –¥–ª—è –±–ª–∏–∂–∞–π—à–∏—Ö —à–∞–≥–æ–≤, –ø—Ä—è–º—ã–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –¥–∞–ª—å–Ω–∏—Ö –≥–æ—Ä–∏–∑–æ–Ω—Ç–æ–≤
              - –§–æ—Ä–º—É–ª–∞: —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –¥–ª—è `h ‚â§ k`, –ø—Ä—è–º–∞—è –¥–ª—è `h > k`
              - **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**: –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ç–æ—á–Ω–æ—Å—Ç—å—é –∏ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç—å—é
              - **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**: –¢—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `k` (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö —à–∞–≥–æ–≤)
            
            **–ú–µ—Ç—Ä–∏–∫–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:**
            - `MAE` (Mean Absolute Error) –∏ `RMSE` (Root Mean Squared Error) –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞
            - `MAPE` (Mean Absolute Percentage Error) ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è –æ—à–∏–±–∫–∞
            - –í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è/–ø—Ä–æ–≥–Ω–æ–∑–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
            - –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ (—Å—É–º–º–∞ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø–æ —à–∞–≥–∞–º)
            
            **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
            - –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –≥–æ—Ä–∏–∑–æ–Ω—Ç–æ–≤ (h ‚â§ 3): —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
            - –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –≥–æ—Ä–∏–∑–æ–Ω—Ç–æ–≤ (h > 7): –ø—Ä—è–º–∞—è –∏–ª–∏ –≥–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
            - –î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π: –ø—Ä—è–º–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å)
            """
            )
        
        analysis_data = stage3(analysis_data, lab_state, MODEL_FACTORIES, DEFAULT_HORIZONS, DEFAULT_SPLIT)
        st.session_state["analysis_data"] = analysis_data

        # –≠—Ç–∞–ø 4: –ö—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è
        st.markdown("---")
        st.subheader("üß™ –≠—Ç–∞–ø 4. –ö—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤")
        st.caption("–†–∞—Å—à–∏—Ä—è—é—â–µ–µ—Å—è –æ–∫–Ω–æ, —Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ, TimeSeriesSplit. –û—Ü–µ–Ω–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –º–æ–¥–µ–ª–µ–π.")
        
        with st.expander("üìö –¢–µ–æ—Ä–∏—è –ø–æ –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤", expanded=False):
            st.markdown(
            """
            **–°—Ö–µ–º—ã –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤:**
            
            - **–†–∞—Å—à–∏—Ä—è—é—â–µ–µ—Å—è –æ–∫–Ω–æ (Expanding Window)**:
              - –û–±—É—á–∞—é—â–µ–µ –æ–∫–Ω–æ —Ä–∞—Å—Ç–µ—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º, –¥–æ–±–∞–≤–ª—è—è –Ω–æ–≤—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
              - –§–æ—Ä–º—É–ª–∞: Train = [0, t], Test = [t+1, t+h] –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ–ª–¥–∞
              - **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
              - **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**: –°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞
            
            - **–°–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ (Sliding Window)**:
              - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±—É—á–∞—é—â–µ–µ –æ–∫–Ω–æ –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Å–¥–≤–∏–≥–∞–µ—Ç –µ–≥–æ –≤–ø–µ—Ä–µ–¥
              - –§–æ—Ä–º—É–ª–∞: Train = [t-w, t], Test = [t+1, t+h] –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ–ª–¥–∞
              - **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**: –£—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–¥–∞–≤–Ω—é—é –∏—Å—Ç–æ—Ä–∏—é (–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)
              - **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**: –ú–æ–∂–µ—Ç –ø–æ—Ç–µ—Ä—è—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            
            - **TimeSeriesSplit (sklearn)**:
              - –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –æ–±—É—á–∞—é—â—É—é –∏ —Ç–µ—Å—Ç–æ–≤—É—é –≤—ã–±–æ—Ä–∫–∏
              - –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —É—Ç–µ—á–∫–∏ –±—É–¥—É—â–µ–≥–æ –≤ –æ–±—É—á–∞—é—â—É—é –≤—ã–±–æ—Ä–∫—É
              - –§–æ—Ä–º—É–ª–∞: Train = [0, t_i], Test = [t_i+1, t_i+h] –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ–ª–¥–∞ `i`
              - **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**: –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥, –ª–µ–≥–∫–æ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å
              - **–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏**: –ú–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω —Ä–∞–∑–º–µ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö
            
            **–û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞:**
            - –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ö–µ–º—ã –æ—Ü–µ–Ω–∏–≤–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ (MAE, RMSE, MAPE) –Ω–∞ –∫–∞–∂–¥–æ–º —Ñ–æ–ª–¥–µ
            - –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–æ —Ñ–æ–ª–¥–∞–º
            - –ù–∏–∑–∫–æ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ ‚Üí –º–æ–¥–µ–ª—å —Å—Ç–∞–±–∏–ª—å–Ω–∞ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞—Ö
            - –í—ã—Å–æ–∫–æ–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ ‚Üí –º–æ–¥–µ–ª—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∫ –≤—ã–±–æ—Ä—É –æ–±—É—á–∞—é—â–µ–π –≤—ã–±–æ—Ä–∫–∏
            
            **–¶–µ–ª—å –±–ª–æ–∫–∞:** –û—Ü–µ–Ω–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∫–∞—á–µ—Å—Ç–≤–∞ –º–æ–¥–µ–ª–µ–π –±–µ–∑ —É—Ç–µ—á–∫–∏ –±—É–¥—É—â–µ–≥–æ –∏ –≤—ã–±—Ä–∞—Ç—å
            –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å—Ö–µ–º—É –∫—Ä–æ—Å—Å-–≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö.
            """
            )
        
        analysis_data = stage4(analysis_data, lab_state, MODEL_FACTORIES)
        st.session_state["analysis_data"] = analysis_data

        source_df = analysis_data.get("source_df")
        datetime_column = analysis_data.get("datetime_column")
        target_column = analysis_data.get("target_column")

        # –≠—Ç–∞–ø 5: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
        st.markdown("---")
        st.subheader("üìä –≠—Ç–∞–ø 5. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π")
        st.caption("–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –º–æ–¥–µ–ª–µ–π (AR, MA, ARMA, ARIMA, SARIMA, SARIMAX, GARCH, TBATS, Prophet, VAR, VECM, Naive, SES) –Ω–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ.")
        
        with st.expander("üìö –¢–µ–æ—Ä–∏—è –ø–æ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—é –º–æ–¥–µ–ª–µ–π –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤", expanded=False):
            st.markdown(
            """
            **–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –º–æ–¥–µ–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤:**
            
            - **–ë–∞–∑–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ (AR, MA, ARMA, ARIMA, SARIMA, SARIMAX)**:
              - **AR (Autoregressive)**: `X(t) = c + Œ£(œÜ_i * X(t-i)) + Œµ(t)`
              - **MA (Moving Average)**: `X(t) = Œº + Œ£(Œ∏_i * Œµ(t-i)) + Œµ(t)`
              - **ARMA (p, q)**: –ö–æ–º–±–∏–Ω–∞—Ü–∏—è AR –∏ MA –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
              - **ARIMA (p, d, q)**: ARMA —Å –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ—Ä—è–¥–∫–∞ `d`
              - **SARIMA (p, d, q)(P, D, Q)[m]**: ARIMA —Å —Å–µ–∑–æ–Ω–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–π –ø–µ—Ä–∏–æ–¥–∞ `m`
              - **SARIMAX**: SARIMA —Å —ç–∫–∑–æ–≥–µ–Ω–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
              - –ü–æ–¥–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ AIC/BIC –∏–ª–∏ `auto_arima` (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä)
            
            - **–ú–æ–¥–µ–ª–∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (GARCH)**:
              - –ú–æ–¥–µ–ª–∏—Ä—É—é—Ç –∏–∑–º–µ–Ω—è—é—â—É—é—Å—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–∏—Å–ø–µ—Ä—Å–∏—é (–≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å)
              - **GARCH(1,1)**: `œÉ¬≤(t) = œâ + Œ±*Œµ¬≤(t-1) + Œ≤*œÉ¬≤(t-1)`
              - –û–±—É—á–∞–µ—Ç—Å—è –Ω–∞ –æ—Å—Ç–∞—Ç–∫–∞—Ö ARIMA –º–æ–¥–µ–ª–∏
              - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –¥–∞–Ω–Ω—ã—Ö —Å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–µ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
            
            - **–°–µ–∑–æ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ (TBATS, Prophet)**:
              - **TBATS**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–ª–æ–∂–Ω—É—é —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã, –Ω–µ–ª–∏–Ω–µ–π–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã)
              - **Prophet**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç—Ä–µ–Ω–¥—ã, —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏
              - –ü–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –±–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å—é
            
            - **–ú–Ω–æ–≥–æ–º–µ—Ä–Ω—ã–µ –º–æ–¥–µ–ª–∏ (VAR, VECM)**:
              - **VAR (Vector Autoregression)**: –ú–æ–¥–µ–ª–∏—Ä—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤
              - **VECM (Vector Error Correction Model)**: VAR –¥–ª—è –∫–æ–∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤
              - –¢—Ä–µ–±—É—é—Ç ‚â•2 —Ä—è–¥–æ–≤; VECM ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫–æ–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
            
            - **–ë–µ–Ω—á–º–∞—Ä–∫–∏ (Naive, Seasonal Naive, SES)**:
              - **Naive**: `≈∑(t+1) = y(t)` (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
              - **Seasonal Naive**: `≈∑(t+1) = y(t-s)` (–∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ–∑–æ–Ω–∞ –Ω–∞–∑–∞–¥)
              - **SES (Simple Exponential Smoothing)**: –í–∑–≤–µ—à–µ–Ω–Ω–æ–µ —Å—Ä–µ–¥–Ω–µ–µ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º —É–±—ã–≤–∞–Ω–∏–µ–º –≤–µ—Å–æ–≤
            
            **–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è:**
            - –í—Å–µ –º–æ–¥–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç Box-Cox –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –¥–∏—Å–ø–µ—Ä—Å–∏–∏
            - –ü–æ—Å–ª–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Box-Cox
            - –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã —Ç–∞–∫–∂–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ
            
            **–¶–µ–ª—å –±–ª–æ–∫–∞:** –°—Ä–∞–≤–Ω–∏—Ç—å –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –º–æ–¥–µ–ª–∏ –Ω–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ
            –∏ –≤—ã–±—Ä–∞—Ç—å –ª—É—á—à—É—é –º–æ–¥–µ–ª—å –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º –∫–∞—á–µ—Å—Ç–≤–∞.
            """
            )
        
        analysis_data = stage5(
            analysis_data,
            lab_state,
            source_df,
            datetime_column,
            target_column,
            MODEL_FACTORIES,
            pm if PMDARIMA_AVAILABLE else None,
            arch_model if ARCH_AVAILABLE else None,
            TBATS if TBATS_AVAILABLE else None,
            Prophet if PROPHET_AVAILABLE else None,
            PMDARIMA_AVAILABLE,
            ARCH_AVAILABLE,
            TBATS_AVAILABLE,
            PROPHET_AVAILABLE,
        )
        st.session_state["analysis_data"] = analysis_data

        # –≠—Ç–∞–ø 6: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–æ–¥–µ–ª–µ–π
        st.markdown("---")
        st.subheader("üîç –≠—Ç–∞–ø 6. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –º–æ–¥–µ–ª–µ–π")
        st.caption("–¢–µ—Å—Ç—ã –õ—å—é–Ω–≥–∞-–ë–æ–∫—Å–∞, –®–∞–ø–∏—Ä–æ-–£–∏–ª–∫–∞, Breusch-Pagan, ACF/PACF –æ—Å—Ç–∞—Ç–∫–æ–≤. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ –¥–ª—è —Ç–æ–ø-3 –º–æ–¥–µ–ª–µ–π.")
        
        with st.expander("üìö –¢–µ–æ—Ä–∏—è –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –º–æ–¥–µ–ª–µ–π", expanded=False):
            st.markdown(
            """
            **–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤:**
            
            - **–¢–µ—Å—Ç –õ—å—é–Ω–≥–∞-–ë–æ–∫—Å–∞ (Ljung-Box)**:
              - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –≤ –æ—Å—Ç–∞—Ç–∫–∞—Ö –º–æ–¥–µ–ª–∏
              - H0: –æ—Å—Ç–∞—Ç–∫–∏ –Ω–µ –∏–º–µ—é—Ç –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ (–±–µ–ª—ã–π —à—É–º)
              - –ï—Å–ª–∏ p-value > 0.05 ‚Üí –æ—Å—Ç–∞—Ç–∫–∏ ‚Äî –±–µ–ª—ã–π —à—É–º (–º–æ–¥–µ–ª—å –∞–¥–µ–∫–≤–∞—Ç–Ω–∞)
              - –ï—Å–ª–∏ p-value ‚â§ 0.05 ‚Üí –µ—Å—Ç—å –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è (–º–æ–¥–µ–ª—å —Ç—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è)
              - **–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è**: –•–æ—Ä–æ—à–∞—è –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ –∏–º–µ—Ç—å –æ—Å—Ç–∞—Ç–∫–∏, –ø–æ—Ö–æ–∂–∏–µ –Ω–∞ –±–µ–ª—ã–π —à—É–º
            
            - **–¢–µ—Å—Ç –ë—Ä–æ–π—à–∞-–ü–∞–≥–∞–Ω–∞ (Breusch-Pagan)**:
              - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–æ–º–æ—Å–∫–µ–¥–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å –æ—Å—Ç–∞—Ç–∫–æ–≤ (–ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–æ –¥–∏—Å–ø–µ—Ä—Å–∏–∏)
              - H0: –æ—Å—Ç–∞—Ç–∫–∏ –≥–æ–º–æ—Å–∫–µ–¥–∞—Å—Ç–∏—á–Ω—ã (–¥–∏—Å–ø–µ—Ä—Å–∏—è –ø–æ—Å—Ç–æ—è–Ω–Ω–∞)
              - –ï—Å–ª–∏ p-value > 0.05 ‚Üí –≥–æ–º–æ—Å–∫–µ–¥–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å (–º–æ–¥–µ–ª—å –∞–¥–µ–∫–≤–∞—Ç–Ω–∞)
              - –ï—Å–ª–∏ p-value ‚â§ 0.05 ‚Üí –≥–µ—Ç–µ—Ä–æ—Å–∫–µ–¥–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å (–¥–∏—Å–ø–µ—Ä—Å–∏—è –º–µ–Ω—è–µ—Ç—Å—è)
              - **–í–∏–∑—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑**: –ì—Ä–∞—Ñ–∏–∫ –æ—Å—Ç–∞—Ç–∫–∏ vs –ø—Ä–æ–≥–Ω–æ–∑—ã (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–µ–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤)
            
            - **–¢–µ—Å—Ç –®–∞–ø–∏—Ä–æ-–£–∏–ª–∫–∞ (Shapiro-Wilk)**:
              - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤
              - H0: –æ—Å—Ç–∞—Ç–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –Ω–æ—Ä–º–∞–ª—å–Ω–æ
              - –ï—Å–ª–∏ p-value > 0.05 ‚Üí –Ω–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç—å (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–æ–¥–µ–ª–µ–π)
              - –ï—Å–ª–∏ p-value ‚â§ 0.05 ‚Üí —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ
              - **–í–∏–∑—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑**: Q-Q plot (–∫–≤–∞–Ω—Ç–∏–ª—å-–∫–≤–∞–Ω—Ç–∏–ª—å –≥—Ä–∞—Ñ–∏–∫)
            
            **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
            
            - **ACF/PACF –æ—Å—Ç–∞—Ç–∫–æ–≤**:
              - ACF (Autocorrelation Function): –ê–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤ –ø–æ –ª–∞–≥–∞–º
              - PACF (Partial Autocorrelation Function): –ß–∞—Å—Ç–∏—á–Ω–∞—è –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤
              - –î–ª—è —Ö–æ—Ä–æ—à–µ–π –º–æ–¥–µ–ª–∏: –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è ACF/PACF –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
              - –í—ã—Ö–æ–¥ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ ‚Üí –Ω–∞–ª–∏—á–∏–µ –∞–≤—Ç–æ–∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –≤ –æ—Å—Ç–∞—Ç–∫–∞—Ö
            
            - **–ì—Ä–∞—Ñ–∏–∫ –æ—Å—Ç–∞—Ç–∫–æ–≤ –≤–æ –≤—Ä–µ–º–µ–Ω–∏**:
              - –û—Å—Ç–∞—Ç–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ª—É—á–∞–π–Ω—ã–º–∏, –±–µ–∑ —Ç—Ä–µ–Ω–¥–æ–≤ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
              - –ù–∞–ª–∏—á–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ ‚Üí –º–æ–¥–µ–ª—å –Ω–µ —É–ª–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            
            - **–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤**:
              - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤
              - –î–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤: –∫–æ–ª–æ–∫–æ–ª–æ–æ–±—Ä–∞–∑–Ω–∞—è —Ñ–æ—Ä–º–∞ (–Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)
            
            **–¶–µ–ª—å –±–ª–æ–∫–∞:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ –∞–Ω–∞–ª–∏–∑ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å,
            —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ —É–ª—É—á—à–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏–ª–∏ –≤—ã–±–æ—Ä –¥—Ä—É–≥–æ–π –º–æ–¥–µ–ª–∏.
            """
            )
        
        analysis_data = stage6(analysis_data, lab_state)
        st.session_state["analysis_data"] = analysis_data

        # –≠—Ç–∞–ø 7: –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
        st.markdown("---")
        st.subheader("üìà –≠—Ç–∞–ø 7. –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ")
        st.caption("–ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ (MAE, RMSE, MAPE, MASE, SMAPE, R¬≤, RMSLE), —Ç–µ—Å—Ç Diebold‚ÄìMariano, —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π.")
        
        with st.expander("üìö –¢–µ–æ—Ä–∏—è –ø–æ –æ—Ü–µ–Ω–∫–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–º—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—é", expanded=False):
            st.markdown(
            """
            **–ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞:**
            
            - **MAE (Mean Absolute Error)**: `MAE = mean(|y_true - y_pred|)`
              - –°—Ä–µ–¥–Ω—è—è –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –æ—à–∏–±–∫–∞, —É—Å—Ç–æ–π—á–∏–≤–∞ –∫ –≤—ã–±—Ä–æ—Å–∞–º
            
            - **RMSE (Root Mean Squared Error)**: `RMSE = sqrt(mean((y_true - y_pred)¬≤))`
              - –ö–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∫ –±–æ–ª—å—à–∏–º –æ—à–∏–±–∫–∞–º
            
            - **MAPE (Mean Absolute Percentage Error)**: `MAPE = mean(|y_true - y_pred| / |y_true|) * 100`
              - –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è –æ—à–∏–±–∫–∞, –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å –º–æ–¥–µ–ª–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –º–∞—Å—à—Ç–∞–±–∞—Ö
            
            - **MASE (Mean Absolute Scaled Error)**: `MASE = MAE / MAE_naive`
              - –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–∞–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞
              - MASE < 1 ‚Üí –º–æ–¥–µ–ª—å –ª—É—á—à–µ –Ω–∞–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞
              - MASE > 1 ‚Üí –º–æ–¥–µ–ª—å —Ö—É–∂–µ –Ω–∞–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞
            
            - **SMAPE (Symmetric MAPE)**: `SMAPE = mean(|y_true - y_pred| / ((|y_true| + |y_pred|) / 2)) * 100`
              - –°–∏–º–º–µ—Ç—Ä–∏—á–Ω–∞—è –≤–µ—Ä—Å–∏—è MAPE, –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –º–∞–ª—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö
            
            - **R¬≤ (Coefficient of Determination)**: `R¬≤ = 1 - SS_res / SS_tot`
              - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ–ª—é –æ–±—ä—è—Å–Ω–µ–Ω–Ω–æ–π –¥–∏—Å–ø–µ—Ä—Å–∏–∏
              - R¬≤ = 1 ‚Üí –∏–¥–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑, R¬≤ = 0 ‚Üí –º–æ–¥–µ–ª—å –Ω–µ –ª—É—á—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ
            
            - **RMSLE (Root Mean Squared Logarithmic Error)**: `RMSLE = sqrt(mean((log(y_true+1) - log(y_pred+1))¬≤))`
              - –õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ª–æ–≥-—Ä—è–¥–æ–≤
            
            **–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π:**
            
            - **–¢–µ—Å—Ç Diebold‚ÄìMariano (DM Test)**:
              - –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–æ—á–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –¥–≤—É—Ö –º–æ–¥–µ–ª–µ–π
              - H0: –°—Ä–µ–¥–Ω—è—è –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞ –¥–≤—É—Ö –º–æ–¥–µ–ª–µ–π –æ–¥–∏–Ω–∞–∫–æ–≤–∞
              - –ï—Å–ª–∏ p-value < 0.05 ‚Üí –º–æ–¥–µ–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–ª–∏—á–∞—é—Ç—Å—è
              - –ï—Å–ª–∏ p-value ‚â• 0.05 ‚Üí —Ä–∞–∑–ª–∏—á–∏–µ –Ω–µ–∑–Ω–∞—á–∏–º–æ
              - **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**: –í—ã–±–æ—Ä –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –∏–∑ –¥–≤—É—Ö –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤
            
            **–†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π:**
            
            - **–í–∑–≤–µ—à–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞**: –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤
              - –§–æ—Ä–º—É–ª–∞: `Score = w1 * MASE + w2 * (1 - p(LB)) + w3 * (1 - p(SW))`
              - –£—á–∏—Ç—ã–≤–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ (MASE) –∏ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (p-values —Ç–µ—Å—Ç–æ–≤)
              - –ú–µ–Ω—å—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Üí –ª—É—á—à–∞—è –º–æ–¥–µ–ª—å
            
            **–¶–µ–ª—å –±–ª–æ–∫–∞:** –°—Ä–∞–≤–Ω–∏—Ç—å –≤—Å–µ –º–æ–¥–µ–ª–∏ –ø–æ –º–µ—Ç—Ä–∏–∫–∞–º –∫–∞—á–µ—Å—Ç–≤–∞, –ø—Ä–æ–≤–µ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ
            —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–π.
            """
            )
        
        analysis_data = stage7(analysis_data, lab_state)
        st.session_state["analysis_data"] = analysis_data

        # –≠—Ç–∞–ø 9: –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        st.markdown("---")
        st.subheader("üéØ –≠—Ç–∞–ø 9. –í—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")
        st.caption("–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –º–æ–¥–µ–ª–µ–π, –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É (Prophet vs SARIMAX, TBATS, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏).")
        
        with st.expander("üìö –¢–µ–æ—Ä–∏—è –ø–æ –≤—ã–≤–æ–¥–∞–º –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º", expanded=False):
            st.markdown(
            """
            **–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –º–æ–¥–µ–ª–µ–π:**
            
            –í—ã–±–æ—Ä –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –¥–æ–ª–∂–µ–Ω —É—á–∏—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤:
            
            1. **–ö–∞—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ (–º–µ—Ç—Ä–∏–∫–∏)**:
               - MAE, RMSE, MAPE, MASE ‚Äî —á–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º –ª—É—á—à–µ
               - R¬≤ ‚Äî —á–µ–º –±–æ–ª—å—à–µ, —Ç–µ–º –ª—É—á—à–µ
               - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞—Ö (h=1, 7, 30)
            
            2. **–ê–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã)**:
               - –¢–µ—Å—Ç –õ—å—é–Ω–≥–∞-–ë–æ–∫—Å–∞: p-value > 0.05 ‚Üí –æ—Å—Ç–∞—Ç–∫–∏ ‚Äî –±–µ–ª—ã–π —à—É–º
               - –¢–µ—Å—Ç –®–∞–ø–∏—Ä–æ-–£–∏–ª–∫–∞: p-value > 0.05 ‚Üí –æ—Å—Ç–∞—Ç–∫–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã
               - –¢–µ—Å—Ç –ë—Ä–æ–π—à–∞-–ü–∞–≥–∞–Ω–∞: p-value > 0.05 ‚Üí –≥–æ–º–æ—Å–∫–µ–¥–∞—Å—Ç–∏—á–Ω–æ—Å—Ç—å
               - –•–æ—Ä–æ—à–∞—è –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
            
            3. **–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å**:
               - –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –º–æ–¥–µ–ª–∏ (ARIMA, SARIMA) ‚Äî –≤—ã—Å–æ–∫–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å
               - –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ (RandomForest) ‚Äî –Ω–∏–∑–∫–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å
               - –í—ã–±–æ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –±–∏–∑–Ω–µ—Å–∞ –∏ —Ä–µ–≥—É–ª—è—Ü–∏–π
            
            4. **–í—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å**:
               - –í—Ä–µ–º—è –æ–±—É—á–µ–Ω–∏—è –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è
               - –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ä–µ—Å—É—Ä—Å–∞–º (–ø–∞–º—è—Ç—å, CPU)
               - –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
            
            **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:**
            
            - **Prophet vs SARIMAX**:
              - Prophet: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å, –≤—ã–±—Ä–æ—Å—ã, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–≤
              - SARIMAX: –û–¥–Ω–∞ —á–µ—Ç–∫–∞—è —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å, –≤—ã—Å–æ–∫–∞—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å, –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            
            - **TBATS**:
              - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è —Å–ª–æ–∂–Ω–æ–π —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏ (–Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã)
              - –ù–µ –Ω—É–∂–µ–Ω –ø—Ä–∏ –ø—Ä–æ—Å—Ç–æ–π —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏ (–æ–¥–Ω–∞ –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å)
              - –¢—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω–∏–º—É–º 2-3 —Å–µ–∑–æ–Ω–∞)
            
            - **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏**:
              - –ü—Ä–æ—Å—Ç—ã–µ –º–æ–¥–µ–ª–∏ (Naive, SES): –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
              - –°—Ä–µ–¥–Ω–∏–µ –º–æ–¥–µ–ª–∏ (ARIMA, LinearRegression): –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
              - –°–ª–æ–∂–Ω—ã–µ –º–æ–¥–µ–ª–∏ (SARIMA, TBATS, Prophet): –µ–∂–µ–º–µ—Å—è—á–Ω–æ
              - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞—á–µ—Å—Ç–≤–∞: –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö—É–¥—à–µ–Ω–∏–∏ –º–µ—Ç—Ä–∏–∫ –Ω–∞ 20%
            
            **–¶–µ–ª—å –±–ª–æ–∫–∞:** –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É –≤—Å–µ—Ö –º–æ–¥–µ–ª–µ–π, –æ–±–æ—Å–Ω–æ–≤–∞—Ç—å –≤—ã–±–æ—Ä
            –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –∏ –¥–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.
            """
            )
        
        analysis_data = stage9(analysis_data, lab_state)
        st.session_state["analysis_data"] = analysis_data

if __name__ == "__main__":
    main()


